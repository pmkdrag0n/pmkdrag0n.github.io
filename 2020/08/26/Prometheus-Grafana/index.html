<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Prometheus &amp; Grafana - pmk&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="pmk&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="pmk&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="pmk&amp;#39;s personal blog"><meta property="og:type" content="blog"><meta property="og:title" content="pmk&#039;s blog"><meta property="og:url" content="https://pmkhoi.com/"><meta property="og:site_name" content="pmk&#039;s Blog"><meta property="og:description" content="pmk&amp;#39;s personal blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://pmkdrag0n.github.io/images/logo.jpg"><meta property="article:published_time" content="2020-08-27T06:42:56.000Z"><meta property="article:modified_time" content="2020-10-29T08:31:37.147Z"><meta property="article:author" content="Pham Minh Khoi"><meta property="article:tag" content="Monitor"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://pmkdrag0n.github.io/images/logo.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://pmkhoi.com/2020/08/26/Prometheus-Grafana/"},"headline":"pmk's Blog","image":["http://pmkhoi.com/images/blog5/1.jpg"],"datePublished":"2020-08-27T06:42:56.000Z","dateModified":"2020-10-29T08:31:37.147Z","author":{"@type":"Person","name":"Pham Minh Khoi"},"description":"Đây là một dự án nhỏ của mình về hệ thống giám sát các thiết bị ở nhà tầm 5-10 người sử dụng. Tất cả đểu được triển khai trên một thiết bị Single-board computer (arm64). Hệ thống sẽ bao gồm Prometheus"}</script><link rel="canonical" href="http://pmkhoi.com/2020/08/26/Prometheus-Grafana/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">pmk&#039;s blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/cheat_sheet">Cheat Sheets</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="My GitHub" href="https://github.com/pmkdrag0n"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/images/blog5/1.jpg" alt="Prometheus &amp; Grafana"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-08-27T06:42:56.000Z" title="2020-08-27T06:42:56.000Z">26-08-2020</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-10-29T08:31:37.147Z" title="2020-10-29T08:31:37.147Z">29-10-2020</time></span><span class="level-item"><a class="link-muted" href="/categories/Linux/">Linux</a></span><span class="level-item">16 minutes read (About 2440 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Prometheus &amp; Grafana</h1><div class="content"><p>Đây là một dự án nhỏ của mình về hệ thống giám sát các thiết bị ở nhà tầm 5-10 người sử dụng. Tất cả đểu được triển khai trên một thiết bị Single-board computer (arm64). Hệ thống sẽ bao gồm Prometheus và Node_Exporter để lấy metric từ các thiết bị và Grafana để tạo Dashboard theo dõi các thông số dưới dạng biểu đồ.</p>
<a id="more"></a>

<h2 id="Prometheus-la-gi"><a href="#Prometheus-la-gi" class="headerlink" title="Prometheus là gì?"></a><strong>Prometheus là gì?</strong></h2><p>Prometheus là một công cụ được sử dụng rộng rãi trong việc giám sát và cảnh báo hệ thống. Prometheus theo dõi các thông số của hệ thống trên thời gian thật và được xây dựng sẵn. Sử dụng các exporter để lấy thông tin của các host thu về server. Prometheus được tích hợp nhiều công cụ khác nhau như Grafana, Node_Exporter, Alertmanager,… vì thế việc Prometheus được sử dụng rộng rãi là điều không cần bàn tới.</p>
<h2 id="Grafana-la-gi"><a href="#Grafana-la-gi" class="headerlink" title="Grafana là gì?"></a><strong>Grafana là gì?</strong></h2><p>Grafana là một platform open source dụng để phân tích dữ liệu và thể hiện các dữ liệu thành các biểu đồ, đồ thị trên giao diện web. Là một công cụ phân tích dữ liệu thì Grafana thường xuyên được sử dụng kèm với các bộ Monitor, thường được tích hợp để hiển thị dữ liệu từ Prometheus, InfluxDB, và Graphite. Hoặc các công cụ monitor khác như Zabbix, Icinga, PRTG,…</p>
<h2 id="Chuan-bi"><a href="#Chuan-bi" class="headerlink" title="Chuẩn bị"></a><strong>Chuẩn bị</strong></h2><p>Chuẩn bị:</p>
<ul>
<li>Một Server Linux dùng để cài đặt Prometheus và Grafana </li>
<li>Một vài thiết bị hỗ trợ SNMP hoặc nhân UNIX để tiến hành giám sát</li>
</ul>
<p>Mô hình:</p>
<p><img src="/images/blog5/2.png"></p>
<p>Thiết bị mình dùng để giám sát là 1 con router TP-Link C50v4 chạy firmware <a target="_blank" rel="noopener" href="https://openwrt.org/">Openwrt</a>  và chính server Linux của mình.</p>
<ul>
<li>Openwrt: 192.168.0.1</li>
<li>Server Prometheus: 192.168.0.169</li>
</ul>
<p>Ở đây Node_Exporter sẽ lấy thông tin host đưa về Prometheus. Dữ liệu thô từ Prometheus sẽ được chuyển lên Grafana thành các dạng biểu đồ để chúng ta có thể theo dõi dễ dàng.</p>
<h2 id="Cai-dat-va-cau-hinh-Prometheus"><a href="#Cai-dat-va-cau-hinh-Prometheus" class="headerlink" title="Cài đặt và cấu hình Prometheus"></a><strong>Cài đặt và cấu hình Prometheus</strong></h2><p>Các bản Prometheus sẽ được public tại <a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/releases/">đây</a>. Ở đây mình sẽ sử dụng bản prometheus-2.2.0.1.linux-arm64 để cài đặt. Tiến hành tải về và bắt đầu cấu hình</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download prometheus-2.2.0.1.linux-arm64.tar.gz </span></span><br><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.20.1/prometheus-2.20.1.linux-arm64.tar.gz</span><br><span class="line"><span class="comment"># Giải nén file vừa tải và copy vào hệ thống</span></span><br><span class="line">tar -xvf prometheus-2.20.1.linux-arm64.tar.gz</span><br><span class="line">cp prometheus-2.20.1.linux-arm64 /etc/prometheus</span><br></pre></td></tr></table></figure>

<p>Sau khi chuyển xong thì thư mục prometheus sẽ như sau</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">blackdrag0n@BlackDrag0n:&#x2F;etc&#x2F;prometheus$ ls -ll</span><br><span class="line">total 146876</span><br><span class="line">drwxr-xr-x 2 blackdrag0n blackdrag0n     4096 Aug  6 02:39 console_libraries</span><br><span class="line">drwxr-xr-x 2 blackdrag0n blackdrag0n     4096 Aug  6 02:39 consoles</span><br><span class="line">-rw-r--r-- 1 blackdrag0n blackdrag0n    11357 Aug  6 02:39 LICENSE</span><br><span class="line">-rw-r--r-- 1 blackdrag0n blackdrag0n     3420 Aug  6 02:39 NOTICE</span><br><span class="line">-rwxr-xr-x 1 blackdrag0n blackdrag0n 87039446 Aug  6 01:43 prometheus</span><br><span class="line">-rw-r--r-- 1 blackdrag0n blackdrag0n     1143 Aug 26 06:18 prometheus.yml</span><br><span class="line">-rwxr-xr-x 1 blackdrag0n blackdrag0n 48818187 Aug  6 01:45 promtool</span><br><span class="line">-rwxr-xr-x 1 blackdrag0n blackdrag0n 14509304 Aug  6 01:46 tsdb</span><br></pre></td></tr></table></figure>

<p>Ở đây chúng ta chỉ cần quan tâm file prometheus và file config prometheus.yml. Tạo file service cho Prometheus trong thư mục /etc/systemd/system/promethus.service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;promethus.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Prometheus</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">ExecStart&#x3D;&#x2F;etc&#x2F;prometheus&#x2F;prometheus \</span><br><span class="line">    --config.file &#x2F;etc&#x2F;prometheus&#x2F;prometheus.yml \</span><br><span class="line">    --storage.tsdb.path &#x2F;var&#x2F;lib&#x2F;prometheus&#x2F; \</span><br><span class="line">    --web.console.templates&#x3D;&#x2F;etc&#x2F;prometheus&#x2F;consoles \</span><br><span class="line">    --web.console.libraries&#x3D;&#x2F;etc&#x2F;prometheus&#x2F;console_libraries</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>

<p>Tiến hành khởi chạy Service Prometheus bằng lệnh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start prometheus</span><br></pre></td></tr></table></figure>

<p>Kiểm tra tiến trình Prometheus đang chạy có lỗi gì hay không</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">blackdrag0n@BlackDrag0n:&#x2F;etc&#x2F;prometheus$ systemctl status prometheus</span><br><span class="line">● prometheus.service - Prometheus</span><br><span class="line">   Loaded: loaded (&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;prometheus.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Wed 2020-08-26 06:18:15 +07; 18h ago</span><br><span class="line"> Main PID: 5255 (prometheus)</span><br><span class="line">    Tasks: 13 (limit: 3226)</span><br><span class="line">   CGroup: &#x2F;system.slice&#x2F;prometheus.service</span><br><span class="line">           └─5255 &#x2F;etc&#x2F;prometheus&#x2F;prometheus --config.file &#x2F;etc&#x2F;prometheus&#x2F;prometheus.yml --storage.tsdb.path &#x2F;var&#x2F;lib&#x2F;p</span><br><span class="line"></span><br><span class="line">Aug 26 18:00:05 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T11:00:05.386Z caller&#x3D;compact.go:441 component&#x3D;tsd</span><br><span class="line">Aug 26 20:00:04 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T13:00:04.164Z caller&#x3D;compact.go:495 component&#x3D;tsd</span><br><span class="line">Aug 26 20:00:04 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T13:00:04.221Z caller&#x3D;head.go:804 component&#x3D;tsdb m</span><br><span class="line">Aug 26 22:00:03 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T15:00:03.970Z caller&#x3D;compact.go:495 component&#x3D;tsd</span><br><span class="line">Aug 26 22:00:04 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T15:00:04.007Z caller&#x3D;head.go:804 component&#x3D;tsdb m</span><br><span class="line">Aug 26 22:00:04 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T15:00:04.122Z caller&#x3D;checkpoint.go:96 component&#x3D;t</span><br><span class="line">Aug 26 22:00:05 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T15:00:05.056Z caller&#x3D;head.go:884 component&#x3D;tsdb m</span><br><span class="line">Aug 26 22:00:05 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T15:00:05.680Z caller&#x3D;compact.go:441 component&#x3D;tsd</span><br><span class="line">Aug 27 00:00:03 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T17:00:03.966Z caller&#x3D;compact.go:495 component&#x3D;tsd</span><br><span class="line">Aug 27 00:00:04 BlackDrag0n prometheus[5255]: level&#x3D;info ts&#x3D;2020-08-26T17:00:04.005Z caller&#x3D;head.go:804 component&#x3D;tsdb m</span><br></pre></td></tr></table></figure>

<p>Khi này truy cập vào giao diện web của prometheus với cú pháp http://[Server IP]:9090 sẽ ra được giao diện giống hình</p>
<p><img src="/images/blog5/3.png"></p>
<h2 id="Cai-dat-va-cau-hinh-Node-Exporter"><a href="#Cai-dat-va-cau-hinh-Node-Exporter" class="headerlink" title="Cài đặt và cấu hình Node_Exporter"></a><strong>Cài đặt và cấu hình Node_Exporter</strong></h2><p>Các bản Node_exporter release tại <a target="_blank" rel="noopener" href="https://github.com/prometheus/node_exporter/releases">đây</a>. Tương tự như trên thì ở đây mình dùng bản  node_exporter-1.0.1.linux.arm64. Tiến hành tải về và tiền hành cài đặt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Download Node_exporter</span><br><span class="line"> wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;node_exporter&#x2F;releases&#x2F;download&#x2F;v1.0.1&#x2F;node_exporter-1.0.1.linux-arm64.tar.gz</span><br><span class="line"># giải nén file vừa tải</span><br><span class="line">tar -xvf node_exporter-1.0.1.linux-arm64.tar.gz</span><br></pre></td></tr></table></figure>

<p>Khi giải nén xong sẽ được thư mục node_exporter như sau</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">blackdrag0n@BlackDrag0n:~&#x2F;node_exporter-1.0.1.linux-arm64$ ls -ll</span><br><span class="line">total 18376</span><br><span class="line">-rw-r--r-- 1 blackdrag0n blackdrag0n    11357 Jun 16 20:19 LICENSE</span><br><span class="line">-rwxr-xr-x 1 blackdrag0n blackdrag0n 18800055 Jun 16 19:47 node_exporter</span><br><span class="line">-rw-r--r-- 1 blackdrag0n blackdrag0n      463 Jun 16 20:19 NOTICE</span><br></pre></td></tr></table></figure>

<p>Ở đây ta cần copy file node_exporter vào đường dẫn /usr/local/bin/ và tạo service </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Chuyển node_exporter vào hệ thống</span><br><span class="line">cp ~&#x2F;node_exporter-1.0.1.linux-arm64&#x2F;node_exporter &#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line"># tạo service</span><br><span class="line">vim &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;node_exporter.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Node Exporter</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;node_exporter</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Sau khi tạo xong khởi chạy tiến trình và kiểm tra xem node_exporter đã chạy có bị lỗi gì hay không</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">system daemon-reload &amp;&amp; systemctl restart node_exporter.service</span><br><span class="line"># kiểm tra tiến trình node_exporter</span><br><span class="line">blackdrag0n@BlackDrag0n:~$ systemctl status node_exporter.service</span><br><span class="line">● node_exporter.service - Node Exporter</span><br><span class="line">   Loaded: loaded (&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;node_exporter.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Wed 2020-08-26 06:13:07 +07; 1 day 18h ago</span><br><span class="line"> Main PID: 5011 (node_exporter)</span><br><span class="line">    Tasks: 19 (limit: 3226)</span><br><span class="line">   CGroup: &#x2F;system.slice&#x2F;node_exporter.service</span><br><span class="line">           └─5011 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;node_exporter</span><br><span class="line"></span><br><span class="line">Warning: Journal has been rotated since unit was started. Log output is incomplete or unavailable.</span><br></pre></td></tr></table></figure>

<p>Cấu hình node_exporter trong prometheus.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;prometheus&#x2F;promethus.yml</span><br><span class="line"># Thêm vào cuối file 3 target (Có thể target prometheus có sẵn rồi)</span><br><span class="line"># 192.168.0.1 là thiết bị Openwrt của mình</span><br><span class="line"></span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: &#39;prometheus&#39;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#39;localhost:9090&#39;]</span><br><span class="line">  - job_name: &#39;node_exporter&#39;</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#39;localhost:9100&#39;]</span><br><span class="line">  - job_name: &#39;openwrt&#39;</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [&#39;192.168.0.1:9100&#39;]</span><br></pre></td></tr></table></figure>

<p>Lưu lại và restart lại service prometheus</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart prometheus</span><br></pre></td></tr></table></figure>

<p>Sau đó dùng trình duyệt web để kiểm tra với đường dẫn <strong><a target="_blank" rel="noopener" href="http://192.168.0.169:9090/targets">http://192.168.0.169:9090/targets</a></strong> </p>
<p><img src="/images/blog5/10.png"></p>
<p>Như vậy là đã cài đặt xong node_exporter và có thể tiến hành query metric của node_exporter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9100&#x2F;metrics</span><br></pre></td></tr></table></figure>

<p>Lưu ý: Nhớ mở port 9100 để có thể query được.</p>
<h2 id="Node-exporter-tren-Openwrt"><a href="#Node-exporter-tren-Openwrt" class="headerlink" title="Node_exporter trên Openwrt"></a><strong>Node_exporter trên Openwrt</strong></h2><p>Trên Openwrt, thực hiện update và cài đặt các package node_exporter</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install prometheus-node-exporter-lua prometheus-node-exporter-lua-netstat prometheus-node-exporter-lua-openwrt prometheus-node-exporter-lua-wifi prometheus-node-exporter-lua-wifi_stations</span><br></pre></td></tr></table></figure>

<p>Cấu hình node_exporter trên openwrt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;config&#x2F;prometheus-node-exporter-lua</span><br><span class="line"></span><br><span class="line">config prometheus-node-exporter-lua &#39;main&#39;</span><br><span class="line">        option listen_interface &#39;*&#39;</span><br><span class="line">        option listen_ipv6 &#39;0&#39;</span><br><span class="line">        option listen_port &#39;9100&#39;</span><br></pre></td></tr></table></figure>

<p>Tiến hành mở port 9100 cho Openwrt. Sau đó dùng lệnh cURL để kiểm tra các metric của thiết bị openwrt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;192.168.0.1:9100&#x2F;metrics</span><br></pre></td></tr></table></figure>

<h2 id="Cai-dat-Grafana-tren-Docker"><a href="#Cai-dat-Grafana-tren-Docker" class="headerlink" title="Cài đặt Grafana trên Docker"></a><strong>Cài đặt Grafana trên Docker</strong></h2><p>Yêu cầu Server Linux phải được cài đặt sẵn Docker. Tiến hành khởi tạo Container Grafana</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:3000 --name grafana grafana&#x2F;grafana</span><br></pre></td></tr></table></figure>

<p>Với lệnh này mình sẽ có Grafana chạy ở port 80. Sử dụng trình duyệt web để truy cập vào</p>
<p><img src="/images/blog5/4.png"></p>
<p>Đăng nhập với username/password là admin/admin, thay đổi password theo ý của bạn.</p>
<p>Tiến hành cài đặt Prometheus làm Database ở mục Configuration -&gt; Data source -&gt; Add data source -&gt; Prometheus và cấu hình như hình.</p>
<p><img src="/images/blog5/5.png"></p>
<p><img src="/images/blog5/6.png"></p>
<p>Tiếp theo bạn cần có Dashboard, Có thể tự tạo riêng cho mình một DashBoard hoặc có thể lấy sẵn Template về chỉnh sửa. Ở đây mình sử dụng 2 Template dành cho <a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/11147">Openwrt</a> và <a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/1860">Linux Server</a>. Copy code id và vào mục  Create -&gt; Import -&gt; nhập ID vào. Đây là thành quả</p>
<p><strong>Openwrt</strong></p>
<p><img src="/images/blog5/7.png"></p>
<p><strong>Prometheus Server</strong></p>
<p><img src="/images/blog5/8.png"></p>
<p>Ngoài ra, có thể tạo Dashboard và thêm tham số để query thêm như hình dưới là một lệnh query nhiệt độ của Prometheus Server, có thể chỉnh sửa đơn vị trong tab Field như hình</p>
<p><img src="/images/blog5/9.png"></p>
<p>Như vậy mình đã hoàn thành xong hệ thống Monitoring của mình. Nhưng vẫn còn một số vấn đề mình chưa giải quyết được là các metrics của các thiết bị có thể bị khai thác mà ko cần có Username và Password nên mình sẽ tìm cách khắc phục điều đó trong bài sau.</p>
<h2 id="Tai-lieu-tham-khao"><a href="#Tai-lieu-tham-khao" class="headerlink" title="Tài liệu tham khảo"></a><strong>Tài liệu tham khảo</strong></h2><ul>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/">https://prometheus.io/docs/</a></li>
<li><a target="_blank" rel="noopener" href="https://grafana.com/docs/grafana/latest/installation/docker/">https://grafana.com/docs/grafana/latest/installation/docker/</a></li>
</ul>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Monitor/">Monitor</a></div><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f12702e7c76c45e" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/07/21/Thiet-lap-Workstation-danh-cho-DevNet-tren-Windows-voi-WSL-2/"><span class="level-item">Thiết lập Workstation dành cho DevNet trên Windows với WSL 2</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://www.gravatar.com/avatar/40c40de6190268d10debbad8c16fb21b?s=128" alt="Phạm Minh Khôi"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Phạm Minh Khôi</p><p class="is-size-6 is-block">Network Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Ho Chi Minh city, Vietnam</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">5</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/pmkdrag0n" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/pmkdrag0n"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Telegram" href="https://t.me/BlackDrag0n98"><i class="fab fa-telegram"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Badge" href="https://www.youracclaim.com/users/minh-khoi-pham"><i class="fas fa-certificate"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Network-Automation/"><span class="level-start"><span class="level-item">Network Automation</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Monitor/"><span class="tag">Monitor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Setup/"><span class="tag">Setup</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WSL2/"><span class="tag">WSL2</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Prometheus-la-gi"><span class="level-left"><span class="level-item">1</span><span class="level-item">Prometheus là gì?</span></span></a></li><li><a class="level is-mobile" href="#Grafana-la-gi"><span class="level-left"><span class="level-item">2</span><span class="level-item">Grafana là gì?</span></span></a></li><li><a class="level is-mobile" href="#Chuan-bi"><span class="level-left"><span class="level-item">3</span><span class="level-item">Chuẩn bị</span></span></a></li><li><a class="level is-mobile" href="#Cai-dat-va-cau-hinh-Prometheus"><span class="level-left"><span class="level-item">4</span><span class="level-item">Cài đặt và cấu hình Prometheus</span></span></a></li><li><a class="level is-mobile" href="#Cai-dat-va-cau-hinh-Node-Exporter"><span class="level-left"><span class="level-item">5</span><span class="level-item">Cài đặt và cấu hình Node_Exporter</span></span></a></li><li><a class="level is-mobile" href="#Node-exporter-tren-Openwrt"><span class="level-left"><span class="level-item">6</span><span class="level-item">Node_exporter trên Openwrt</span></span></a></li><li><a class="level is-mobile" href="#Cai-dat-Grafana-tren-Docker"><span class="level-left"><span class="level-item">7</span><span class="level-item">Cài đặt Grafana trên Docker</span></span></a></li><li><a class="level is-mobile" href="#Tai-lieu-tham-khao"><span class="level-left"><span class="level-item">8</span><span class="level-item">Tài liệu tham khảo</span></span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><figure class="media-left"><a class="image" href="/2020/08/26/Prometheus-Grafana/"><img src="/images/blog5/1.jpg" alt="Prometheus &amp; Grafana"></a></figure><div class="media-content"><p class="date"><time dateTime="2020-08-27T06:42:56.000Z">26-08-2020</time></p><p class="title"><a href="/2020/08/26/Prometheus-Grafana/">Prometheus &amp; Grafana</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2020/07/21/Thiet-lap-Workstation-danh-cho-DevNet-tren-Windows-voi-WSL-2/"><img src="/images/blog4/blog_4_thumb.png" alt="Thiết lập Workstation dành cho DevNet trên Windows với WSL 2"></a></figure><div class="media-content"><p class="date"><time dateTime="2020-07-21T22:52:40.000Z">21-07-2020</time></p><p class="title"><a href="/2020/07/21/Thiet-lap-Workstation-danh-cho-DevNet-tren-Windows-voi-WSL-2/">Thiết lập Workstation dành cho DevNet trên Windows với WSL 2</a></p><p class="categories"><a href="/categories/Network-Automation/">Network Automation</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2020/07/19/Python-co-ban/"><img src="/images/blog_python/cover_python.jpg" alt="Python cơ bản"></a></figure><div class="media-content"><p class="date"><time dateTime="2020-07-19T16:54:19.000Z">19-07-2020</time></p><p class="title"><a href="/2020/07/19/Python-co-ban/">Python cơ bản</a></p><p class="categories"><a href="/categories/Network-Automation/">Network Automation</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2020/07/18/Ly-do-vi-sao-nen-dung-Arch-Linux/"><img src="/images/blog3/blog_3_1.png" alt="Lý do vì sao nên dùng Arch Linux? "></a></figure><div class="media-content"><p class="date"><time dateTime="2020-07-18T22:43:09.000Z">18-07-2020</time></p><p class="title"><a href="/2020/07/18/Ly-do-vi-sao-nen-dung-Arch-Linux/">Lý do vì sao nên dùng Arch Linux? </a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2020/07/18/Minh-da-setup-Arch-Linux-nhu-the-nao-Part-2-Setup-Nvidia-driver-Zsh-plugins-alias/"><img src="/images/blog2/blog_2_1.png" alt="Mình đã setup Arch Linux như thế nào? (Part 2: Setup Nvidia driver + Zsh plugins + alias)"></a></figure><div class="media-content"><p class="date"><time dateTime="2020-07-18T20:38:16.000Z">18-07-2020</time></p><p class="title"><a href="/2020/07/18/Minh-da-setup-Arch-Linux-nhu-the-nao-Part-2-Setup-Nvidia-driver-Zsh-plugins-alias/">Mình đã setup Arch Linux như thế nào? (Part 2: Setup Nvidia driver + Zsh plugins + alias)</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">August 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">July 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">pmk&#039;s blog</a><p class="is-size-7"><span>&copy; 2020 Pham Minh Khoi</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent " target="_blank" rel="noopener" title="Network|Linux|Code|Stuff|" href="/">Network|Linux|Code|Stuff|</a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Telegram" href="https://t.me/BlackDrag0n98"><i class="fab fa-telegram"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="My GitHub" href="https://github.com/pmkdrag0n"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>